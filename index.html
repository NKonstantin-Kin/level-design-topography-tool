<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>–¢–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä PRO</title>
  <style>
    /* –í—Å–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    body { margin: 0; font-family: Arial; background: #f5f5f5; overflow: hidden; }
    #app { display: flex; height: 100vh; }
    #toolbar { width: 200px; background: #2c3e50; padding: 15px; color: white; box-shadow: 0 0 10px rgba(0,0,0,0.3); overflow-y: auto; }
    /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ ... */
    canvas.move-cursor { cursor: grab; }
    canvas.move-cursor:active { cursor: grabbing; }
    .selection-box { position: absolute; border: 2px dashed #1a73e8; background: rgba(26, 115, 232, 0.1); pointer-events: none; display: none; }
  </style>
</head>
<body>
  <div id="app">
    <div id="toolbar">
      <!-- –í–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π HTML –¥–ª—è toolbar -->
      <div class="tool-section">
        <h3>–õ–∏—Å—Ç—ã</h3>
        <button id="new-sheet" class="tool-btn">+ –ù–æ–≤—ã–π –ª–∏—Å—Ç</button>
      </div>
      <div class="tool-section">
        <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
        <button id="tool-select" class="tool-btn active">üñ±Ô∏è –í—ã–¥–µ–ª–µ–Ω–∏–µ</button>
        <button id="tool-line" class="tool-btn">‚úèÔ∏è –õ–∏–Ω–∏—è</button>
        <button id="tool-rect" class="tool-btn">‚¨ú –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</button>
        <button id="tool-circle" class="tool-btn">üîµ –ö—Ä—É–≥</button>
        <button id="tool-text" class="tool-btn">üî§ –¢–µ–∫—Å—Ç</button>
        <button id="tool-copy" class="tool-btn">‚éò –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å (Ctrl+C)</button>
        <button id="tool-paste" class="tool-btn">‚éô –í—Å—Ç–∞–≤–∏—Ç—å (Ctrl+V)</button>
      </div>
      <!-- ... –æ—Å—Ç–∞–ª—å–Ω–æ–π HTML toolbar ... -->
    </div>
    <div id="canvas-container">
      <div class="tabs" id="sheet-tabs"></div>
      <canvas id="sheet"></canvas>
      <div id="text-input" contenteditable="true"></div>
      <div id="selection-box" class="selection-box"></div>
    </div>
  </div>

  <div id="rename-dialog">
    <!-- –í–∞—à HTML –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è -->
  </div>

  <script>
  // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
  document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const canvas = document.getElementById('sheet');
    const textInput = document.getElementById('text-input');
    const selectionBox = document.getElementById('selection-box');
    
    if (!canvas || !textInput || !selectionBox) {
      console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      return;
    }

    const ctx = canvas.getContext('2d');
    if (!ctx) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç canvas');
      return;
    }

    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
    const CONFIG = {
      INIT_WIDTH: 2500,
      INIT_HEIGHT: 1500,
      GRID_COLOR: '#e0e0e0',
      MARGIN: 200,
      MIN_CANVAS_SIZE: 500
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ canvas
    canvas.width = CONFIG.INIT_WIDTH;
    canvas.height = CONFIG.INIT_HEIGHT;

    // ========== –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
    let state = {
      sheets: [],
      currentSheet: 0,
      currentTool: 'select',
      color: '#000000',
      selectedElement: null,
      clipboard: null,
      undoStack: [],
      redoStack: [],
      grid: { enabled: true, snap: true, step: 20, color: CONFIG.GRID_COLOR },
      elements: [],
      renamingSheet: null,
      textInputActive: false,
      isDrawing: false,
      isResizing: false,
      resizeHandle: null,
      startX: 0,
      startY: 0,
      isMovingCanvas: false,
      canvasOffset: { x: 0, y: 0 },
      lastMousePos: { x: 0, y: 0 },
      isMovingElement: false,
      originalElementPos: null,
      isBoxSelecting: false,
      boxSelectStart: { x: 0, y: 0 }
    };

    // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function drawGrid() {
      if (!state.grid.enabled) return;
      ctx.save();
      ctx.translate(state.canvasOffset.x, state.canvasOffset.y);
      ctx.strokeStyle = state.grid.color;
      ctx.lineWidth = 1;
      
      for (let x = 0; x <= canvas.width; x += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      
      for (let y = 0; y <= canvas.height; y += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
      ctx.restore();
    }

    function renderElements() {
      ctx.save();
      ctx.translate(state.canvasOffset.x, state.canvasOffset.y);
      
      state.elements.forEach((el, index) => {
        // ... –≤–∞—à –∫–æ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ ...
      });
      
      ctx.restore();
    }

    function renderCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
      renderElements();
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
    function initToolbar() {
      const toolsSection = document.querySelector('#toolbar .tool-section:nth-child(2)');
      if (!toolsSection) {
        console.error('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å–µ–∫—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤');
        return;
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
      const groupBtn = document.createElement('button');
      groupBtn.id = 'group-btn';
      groupBtn.className = 'tool-btn';
      groupBtn.textContent = '–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å (Ctrl+G)';
      groupBtn.addEventListener('click', groupElements);
      toolsSection.appendChild(groupBtn);

      const ungroupBtn = document.createElement('button');
      ungroupBtn.id = 'ungroup-btn';
      ungroupBtn.className = 'tool-btn';
      ungroupBtn.textContent = '–†–∞–∑–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å (Ctrl+Shift+G)';
      ungroupBtn.addEventListener('click', ungroupElements);
      toolsSection.appendChild(ungroupBtn);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      document.getElementById('new-sheet').addEventListener('click', createSheet);
      // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ...
    }

    // ========== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
    function init() {
      // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è canvas
      canvas.width = CONFIG.INIT_WIDTH;
      canvas.height = CONFIG.INIT_HEIGHT;
      
      // 2. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      loadFromLocalStorage();
      
      // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      initToolbar();
      
      // 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
      setActiveTool('select');
      
      // 5. –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
      renderCanvas();
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    init();
  });
  </script>
</body>
</html>
