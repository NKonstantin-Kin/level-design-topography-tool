<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Топографический редактор</title>
    <style>
        /* ... (полный CSS из предыдущего ответа без изменений) ... */
    </style>
</head>
<body>
    <!-- ... (полный HTML из предыдущего ответа с исправленными обработчиками) ... -->

    <script>
    "use strict";
    class TopographyEditor {
        constructor() {
            this.canvas = document.getElementById('canvas');
            this.ctx = this.canvas.getContext('2d');
            
            // Правильный порядок инициализации
            this.initState();
            this.initEventListeners();
            this.resizeCanvas();
            this.draw();
        }

        initState() {
            this.state = {
                tabs: [this.createNewTab('Слой 1')],
                currentTabId: null,
                selected: new Set(),
                canvasOffset: { x: 0, y: 0 }, // Инициализация canvasOffset
                scale: 1,
                grid: {
                    visible: true,
                    size: 20,
                    snap: true
                }
            };
            this.state.currentTabId = this.state.tabs[0].id;
        }

        createNewTab(name) {
            return {
                id: Date.now().toString(36),
                name,
                elements: [],
                visible: true,
                locked: false
            };
        }

        initEventListeners() {
            // Обработчики для кнопок интерфейса
            document.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.dataset.action;
                    if(this[action]) this[action]();
                });
            });

            // Остальные обработчики...
        }

        // Добавленные методы для обработки действий
        switchTab(index) {
            if(index >= 0 && index < this.state.tabs.length) {
                this.state.currentTabId = this.state.tabs[index].id;
                this.updateTabButtons();
                this.draw();
            }
        }

        addTab() {
            const newTab = this.createNewTab(`Слой ${this.state.tabs.length + 1}`);
            this.state.tabs.push(newTab);
            this.state.currentTabId = newTab.id;
            this.updateTabButtons();
            this.draw();
        }

        groupSelected() {
            // Заглушка для реализации
            console.log('Группировка элементов');
        }

        ungroupSelected() {
            // Заглушка для реализации
            console.log('Разгруппировка элементов');
        }

        // Остальные методы класса...

    }

    // Инициализация после полной загрузки DOM
    document.addEventListener('DOMContentLoaded', () => {
        window.editor = new TopographyEditor();
        
        // Поздняя привязка обработчиков
        document.getElementById('tabContainer').addEventListener('click', e => {
            if(e.target.matches('[data-tab]')) {
                const index = parseInt(e.target.dataset.tab);
                window.editor.switchTab(index);
            }
        });
    });
    </script>
</body>
</html>
