<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- ... (все мета-теги и стили остаются без изменений) ... -->
</head>
<body>
  <!-- ... (весь HTML остаётся без изменений) ... -->

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // ========== КОНСТАНТЫ И ЭЛЕМЕНТЫ DOM ==========
    const CONFIG = {
      INIT_WIDTH: 2500,
      INIT_HEIGHT: 1500,
      GRID_COLOR: '#e0e0e0',
      MARGIN: 200,
      MIN_CANVAS_SIZE: 500
    };

    const canvas = document.getElementById('sheet');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('text-input');
    const selectionBox = document.getElementById('selection-box');
    const toolsSection = document.querySelector('#toolbar .tool-section:nth-child(2)');

    // ========== СОСТОЯНИЕ ПРИЛОЖЕНИЯ ==========
    let state = {
      sheets: [],
      currentSheet: 0,
      currentTool: 'select',
      color: '#000000',
      selectedElement: null,
      clipboard: null,
      undoStack: [],
      redoStack: [],
      grid: { enabled: true, snap: true, step: 20, color: CONFIG.GRID_COLOR },
      elements: [],
      renamingSheet: null,
      textInputActive: false,
      isDrawing: false,
      isResizing: false,
      resizeHandle: null,
      startX: 0,
      startY: 0,
      isMovingCanvas: false,
      canvasOffset: { x: 0, y: 0 },
      lastMousePos: { x: 0, y: 0 },
      isMovingElement: false,
      originalElementPos: null,
      isBoxSelecting: false,
      boxSelectStart: { x: 0, y: 0 }
    };

    // ========== ОСНОВНЫЕ ФУНКЦИИ ==========
    function drawGrid() {
      if (!state.grid.enabled) return;
      ctx.save();
      ctx.translate(state.canvasOffset.x, state.canvasOffset.y);
      ctx.strokeStyle = state.grid.color;
      ctx.lineWidth = 1;
      
      for (let x = 0; x <= canvas.width; x += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      
      for (let y = 0; y <= canvas.height; y += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
      ctx.restore();
    }

    function renderElements() {
      ctx.save();
      ctx.translate(state.canvasOffset.x, state.canvasOffset.y);
      
      state.elements.forEach((el, index) => {
        ctx.beginPath();
        ctx.strokeStyle = el.color;
        ctx.fillStyle = el.color;
        ctx.lineWidth = 2;
        
        if (el.type === 'line') {
          ctx.moveTo(el.x1, el.y1);
          ctx.lineTo(el.x2, el.y2);
          ctx.stroke();
        } else if (el.type === 'rect') {
          ctx.rect(el.x1, el.y1, el.x2 - el.x1, el.y2 - el.y1);
          ctx.stroke();
        } else if (el.type === 'circle') {
          const radius = Math.sqrt(Math.pow(el.x2 - el.x1, 2) + Math.pow(el.y2 - el.y1, 2));
          ctx.arc(el.x1, el.y1, radius, 0, Math.PI * 2);
          ctx.stroke();
        } else if (el.type === 'text') {
          ctx.font = '16px Arial';
          ctx.fillText(el.content, el.x, el.y);
        } else if (el.type === 'group') {
          ctx.strokeStyle = '#1a73e8';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 3]);
          ctx.strokeRect(el.x, el.y, el.width, el.height);
          ctx.setLineDash([]);
        }
        
        if (index === state.selectedElement) {
          ctx.strokeStyle = '#1a73e8';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 3]);
          
          if (el.type === 'line') {
            ctx.moveTo(el.x1, el.y1);
            ctx.lineTo(el.x2, el.y2);
            ctx.stroke();
          } else if (el.type === 'rect' || el.type === 'group') {
            const width = el.type === 'rect' ? el.x2 - el.x1 : el.width;
            const height = el.type === 'rect' ? el.y2 - el.y1 : el.height;
            ctx.strokeRect(el.x1 || el.x, el.y1 || el.y, width, height);
          } else if (el.type === 'circle') {
            const radius = Math.sqrt(Math.pow(el.x2 - el.x1, 2) + Math.pow(el.y2 - el.y1, 2));
            ctx.arc(el.x1, el.y1, radius, 0, Math.PI * 2);
            ctx.stroke();
          } else if (el.type === 'text') {
            ctx.strokeText(el.content, el.x, el.y);
          }
          ctx.setLineDash([]);
        }
      });
      ctx.restore();
    }

    function renderCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
      renderElements();
    }

    function saveToUndoStack() {
      state.undoStack.push(JSON.stringify({
        elements: JSON.parse(JSON.stringify(state.elements)),
        sheets: JSON.parse(JSON.stringify(state.sheets)),
        currentSheet: state.currentSheet
      }));
      if (state.undoStack.length > 50) state.undoStack.shift();
      state.redoStack = [];
    }

    function undo() {
      if (state.undoStack.length === 0) return;
      state.redoStack.push(JSON.stringify({
        elements: JSON.parse(JSON.stringify(state.elements)),
        sheets: JSON.parse(JSON.stringify(state.sheets)),
        currentSheet: state.currentSheet
      }));
      const prevState = JSON.parse(state.undoStack.pop());
      state.elements = prevState.elements;
      state.sheets = prevState.sheets;
      state.currentSheet = prevState.currentSheet;
      state.elements = state.sheets[state.currentSheet].elements;
      saveToLocalStorage();
      renderCanvas();
    }

    // ========== РАБОТА С ЛИСТАМИ ==========
    function createSheet() {
      if (state.sheets.length >= 10) return alert('Максимум 10 листов!');
      saveToUndoStack();
      
      let sheetNumber = 1;
      while (state.sheets.some(sheet => sheet.name === `Лист ${sheetNumber}`)) {
        sheetNumber++;
      }
      
      const newSheet = {
        id: Date.now(),
        name: `Лист ${sheetNumber}`,
        elements: []
      };
      state.sheets.push(newSheet);
      renderTabs();
      switchSheet(state.sheets.length - 1);
      saveToLocalStorage();
    }

    function renderTabs() {
      const tabsContainer = document.getElementById('sheet-tabs');
      tabsContainer.innerHTML = '';
      
      state.sheets.forEach((sheet, index) => {
        const tab = document.createElement('div');
        tab.className = `tab ${index === state.currentSheet ? 'active' : ''}`;
        tab.innerHTML = `
          ${sheet.name}
          <span class="tab-edit" data-index="${index}">✏️</span>
          <span class="tab-close" data-index="${index}">×</span>
        `;
        tab.onclick = () => switchSheet(index);
        tabsContainer.appendChild(tab);
      });
      
      const newTab = document.createElement('div');
      newTab.className = 'tab';
      newTab.textContent = '+';
      newTab.onclick = createSheet;
      tabsContainer.appendChild(newTab);

      document.querySelectorAll('.tab-close').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          deleteSheet(parseInt(btn.dataset.index));
        };
      });

      document.querySelectorAll('.tab-edit').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          renameSheet(parseInt(btn.dataset.index));
        };
      });
    }

    function switchSheet(index) {
      state.currentSheet = index;
      state.elements = state.sheets[index].elements;
      state.selectedElement = null;
      textInput.style.display = 'none';
      state.textInputActive = false;
      renderCanvas();
      renderTabs();
    }

    function deleteSheet(index) {
      if (state.sheets.length <= 1) return alert('Должен остаться хотя бы один лист!');
      saveToUndoStack();
      state.sheets.splice(index, 1);
      if (state.currentSheet >= index) state.currentSheet = Math.max(0, state.currentSheet - 1);
      renderTabs();
      switchSheet(state.currentSheet);
      saveToLocalStorage();
    }

    function renameSheet(index) {
      state.renamingSheet = index;
      document.getElementById('rename-input').value = state.sheets[index].name;
      document.getElementById('rename-dialog').style.display = 'block';
    }

    function confirmRename() {
      const newName = document.getElementById('rename-input').value.trim();
      if (newName && state.renamingSheet !== null) {
        saveToUndoStack();
        state.sheets[state.renamingSheet].name = newName;
        saveToLocalStorage();
        renderTabs();
      }
      cancelRename();
    }

    function cancelRename() {
      document.getElementById('rename-dialog').style.display = 'none';
      state.renamingSheet = null;
    }

    // ========== ГРУППИРОВКА ЭЛЕМЕНТОВ ==========
    function groupElements() {
      if (state.selectedElement === null) return;
      const selected = state.elements[state.selectedElement];
      if (!selected) return;
      
      saveToUndoStack();
      const group = {
        id: 'group-' + Date.now(),
        type: 'group',
        children: [selected.id],
        x: selected.x1 || selected.x,
        y: selected.y1 || selected.y,
        width: (selected.x2 ? selected.x2 - selected.x1 : ctx.measureText(selected.content).width),
        height: (selected.y2 ? selected.y2 - selected.y1 : 20),
        color: selected.color
      };
      
      state.elements.splice(state.selectedElement, 1);
      state.elements.push(group);
      state.selectedElement = state.elements.length - 1;
      saveToLocalStorage();
      renderCanvas();
    }

    function ungroupElements() {
      if (state.selectedElement === null) return;
      const selected = state.elements[state.selectedElement];
      if (!selected || selected.type !== 'group') return;
      
      saveToUndoStack();
      const groupChildren = state.elements.filter(el => 
        selected.children.includes(el.id)
      );
      
      state.elements.splice(state.selectedElement, 1);
      state.elements = state.elements.concat(groupChildren);
      state.selectedElement = null;
      saveToLocalStorage();
      renderCanvas();
    }

    // ========== ИНСТРУМЕНТЫ ==========
    function setActiveTool(tool) {
      state.currentTool = tool;
      document.querySelectorAll('#toolbar .tool-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`tool-${tool}`).classList.add('active');
      state.selectedElement = null;
      
      if (tool !== 'text') {
        textInput.style.display = 'none';
        state.textInputActive = false;
      }
      renderCanvas();
    }

    // ========== СОХРАНЕНИЕ И ЗАГРУЗКА ==========
    function saveToLocalStorage() {
      state.sheets[state.currentSheet].elements = state.elements;
      localStorage.setItem('levelDesigner', JSON.stringify(state));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('levelDesigner');
      if (saved) {
        state = JSON.parse(saved);
        if (state.sheets.length === 0) {
          createSheet();
        } else {
          state.elements = state.sheets[state.currentSheet].elements;
        }
      } else {
        createSheet();
      }
      state.undoStack = [];
      state.redoStack = [];
      renderTabs();
      renderCanvas();
    }

    // ========== ИНИЦИАЛИЗАЦИЯ ==========
    function initToolbar() {
      // Кнопки группировки
      const groupBtn = document.createElement('button');
      groupBtn.id = 'group-btn';
      groupBtn.className = 'tool-btn';
      groupBtn.textContent = 'Группировать (Ctrl+G)';
      groupBtn.addEventListener('click', groupElements);
      toolsSection.appendChild(groupBtn);

      const ungroupBtn = document.createElement('button');
      ungroupBtn.id = 'ungroup-btn';
      ungroupBtn.className = 'tool-btn';
      ungroupBtn.textContent = 'Разгруппировать (Ctrl+Shift+G)';
      ungroupBtn.addEventListener('click', ungroupElements);
      toolsSection.appendChild(ungroupBtn);

      // Остальные обработчики
      document.getElementById('new-sheet').addEventListener('click', createSheet);
      document.getElementById('toggle-grid').addEventListener('click', function() {
        state.grid.enabled = !state.grid.enabled;
        this.textContent = `Сетка: ${state.grid.enabled ? 'Вкл' : 'Выкл'}`;
        renderCanvas();
      });
      document.getElementById('toggle-snap').addEventListener('click', function() {
        state.grid.snap = !state.grid.snap;
        this.textContent = `Привязка: ${state.grid.snap ? 'Вкл' : 'Выкл'}`;
      });
      document.getElementById('grid-step').addEventListener('change', function(e) {
        state.grid.step = Math.max(10, parseInt(e.target.value));
        renderCanvas();
      });
      document.getElementById('tool-select').addEventListener('click', () => setActiveTool('select'));
      document.getElementById('tool-line').addEventListener('click', () => setActiveTool('line'));
      document.getElementById('tool-rect').addEventListener('click', () => setActiveTool('rect'));
      document.getElementById('tool-circle').addEventListener('click', () => setActiveTool('circle'));
      document.getElementById('tool-text').addEventListener('click', () => setActiveTool('text'));
      document.getElementById('tool-copy').addEventListener('click', copySelected);
      document.getElementById('tool-paste').addEventListener('click', pasteElement);
      document.getElementById('color-picker').addEventListener('input', (e) => {
        state.color = e.target.value;
        if (state.selectedElement !== null) {
          state.elements[state.selectedElement].color = state.color;
          saveToLocalStorage();
          renderCanvas();
        }
      });
      document.getElementById('clear-btn').addEventListener('click', () => {
        if (confirm('Очистить текущий лист?')) {
          saveToUndoStack();
          state.elements = [];
          saveToLocalStorage();
          renderCanvas();
        }
      });
      document.getElementById('export-btn').addEventListener('click', exportToPNG);
      document.getElementById('rename-confirm').addEventListener('click', confirmRename);
      document.getElementById('rename-cancel').addEventListener('click', cancelRename);
    }

    function init() {
      // Инициализация canvas
      canvas.width = CONFIG.INIT_WIDTH;
      canvas.height = CONFIG.INIT_HEIGHT;
      
      // Загрузка состояния
      loadFromLocalStorage();
      
      // Инициализация интерфейса
      initToolbar();
      
      // Установка начального инструмента
      setActiveTool('select');
      
      // Первоначальный рендер
      renderCanvas();
    }

    // Запуск приложения
    init();
  });
  </script>
</body>
</html>
