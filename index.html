<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Level Designer Tool</title>
  <style>
    body { margin: 0; font-family: Arial; overflow: hidden; }
    #app { display: flex; height: 100vh; }
    #toolbar { width: 200px; background: #f5f5f5; border-right: 1px solid #ddd; padding: 10px; overflow-y: auto; }
    #canvas-container { flex: 1; position: relative; overflow: auto; }
    canvas { display: block; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); cursor: crosshair; }
    .tabs { display: flex; background: #eee; padding: 8px 8px 0; }
    .tab { padding: 8px 16px; margin-right: 4px; background: #ddd; border-radius: 4px 4px 0 0; cursor: pointer; }
    .tab.active { background: white; font-weight: bold; }
    .tool-section { margin-bottom: 15px; }
    button { padding: 8px; margin: 4px 0; width: 100%; }
    button.active-tool { background: #4CAF50; color: white; }
  </style>
</head>
<body>
  <div id="app">
    <div id="toolbar">
      <div class="tool-section">
        <h3>–õ–∏—Å—Ç—ã</h3>
        <button id="new-sheet">+ –ù–æ–≤—ã–π –ª–∏—Å—Ç</button>
      </div>
      <div class="tool-section">
        <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
        <button id="tool-line" class="active-tool">‚úèÔ∏è –õ–∏–Ω–∏—è</button>
        <button id="tool-rect">‚¨õ –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</button>
        <button id="tool-text">üî§ –¢–µ–∫—Å—Ç</button>
      </div>
      <div class="tool-section">
        <h3>–°–µ—Ç–∫–∞</h3>
        <button id="toggle-grid">–°–µ—Ç–∫–∞: –í–∫–ª</button>
        <button id="toggle-snap">–ü—Ä–∏–≤—è–∑–∫–∞: –í–∫–ª</button>
        <label>–®–∞–≥ —Å–µ—Ç–∫–∏: <input type="number" id="grid-step" value="20" min="10"></label>
      </div>
    </div>
    <div id="canvas-container">
      <div class="tabs" id="sheet-tabs"></div>
      <canvas id="sheet"></canvas>
    </div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const canvas = document.getElementById('sheet');
    const ctx = canvas.getContext('2d');
    canvas.width = 3000;
    canvas.height = 2000;

    let state = {
      sheets: [],
      currentSheet: 0,
      currentTool: 'line',
      grid: {
        enabled: true,
        snap: true,
        step: 20,
        color: '#ddd'
      },
      elements: []
    };

    // 1. –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
    function drawGrid() {
      if (!state.grid.enabled) return;
      ctx.strokeStyle = state.grid.color;
      ctx.lineWidth = 1;
      for (let x = 0; x <= canvas.width; x += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y <= canvas.height; y += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
    }

    // 2. –õ–∏—Å—Ç—ã
    function createSheet() {
      if (state.sheets.length >= 5) return alert('–ú–∞–∫—Å–∏–º—É–º 5 –ª–∏—Å—Ç–æ–≤!');
      const newSheet = {
        id: Date.now(),
        name: `–õ–∏—Å—Ç ${state.sheets.length + 1}`,
        elements: []
      };
      state.sheets.push(newSheet);
      renderTabs();
      switchSheet(state.sheets.length - 1);
      saveToLocalStorage();
    }

    function switchSheet(index) {
      state.currentSheet = index;
      state.elements = state.sheets[index].elements;
      renderCanvas();
      renderTabs();
    }

    // 3. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    function setActiveTool(tool) {
      state.currentTool = tool;
      document.querySelectorAll('#toolbar button').forEach(btn => {
        btn.classList.remove('active-tool');
      });
      document.getElementById(`tool-${tool}`).classList.add('active-tool');
    }

    // 4. –†–∏—Å–æ–≤–∞–Ω–∏–µ
    canvas.addEventListener('mousedown', (e) => {
      if (state.currentTool === 'line' || state.currentTool === 'rect') {
        const startX = e.offsetX;
        const startY = e.offsetY;
        
        function onMouseMove(e) {
          renderCanvas();
          ctx.beginPath();
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 2;
          
          if (state.currentTool === 'line') {
            ctx.moveTo(startX, startY);
            ctx.lineTo(e.offsetX, e.offsetY);
          } else if (state.currentTool === 'rect') {
            ctx.rect(startX, startY, e.offsetX - startX, e.offsetY - startY);
          }
          
          ctx.stroke();
        }

        function onMouseUp(e) {
          canvas.removeEventListener('mousemove', onMouseMove);
          canvas.removeEventListener('mouseup', onMouseUp);
          
          state.elements.push({
            type: state.currentTool,
            x1: startX,
            y1: startY,
            x2: e.offsetX,
            y2: e.offsetY,
            color: '#000000'
          });
          saveToLocalStorage();
        }

        canvas.addEventListener('mousemove', onMouseMove);
        canvas.addEventListener('mouseup', onMouseUp);
      }
    });

    // 5. –†–µ–Ω–¥–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    function renderElements() {
      state.elements.forEach(el => {
        ctx.beginPath();
        ctx.strokeStyle = el.color;
        ctx.lineWidth = 2;
        
        if (el.type === 'line') {
          ctx.moveTo(el.x1, el.y1);
          ctx.lineTo(el.x2, el.y2);
        } else if (el.type === 'rect') {
          ctx.rect(el.x1, el.y1, el.x2 - el.x1, el.y2 - el.y1);
        }
        
        ctx.stroke();
      });
    }

    // 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    function saveToLocalStorage() {
      state.sheets[state.currentSheet].elements = state.elements;
      localStorage.setItem('levelDesigner', JSON.stringify(state));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('levelDesigner');
      if (saved) state = JSON.parse(saved);
      if (state.sheets.length === 0) createSheet();
      state.elements = state.sheets[state.currentSheet].elements;
      renderTabs();
      renderCanvas();
    }

    // 7. –û–±—â–∏–π —Ä–µ–Ω–¥–µ—Ä
    function renderCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
      renderElements();
    }

    function renderTabs() {
      const tabsContainer = document.getElementById('sheet-tabs');
      tabsContainer.innerHTML = '';
      state.sheets.forEach((sheet, index) => {
        const tab = document.createElement('div');
        tab.className = `tab ${index === state.currentSheet ? 'active' : ''}`;
        tab.textContent = sheet.name;
        tab.onclick = () => switchSheet(index);
        tabsContainer.appendChild(tab);
      });
      const newTab = document.createElement('div');
      newTab.className = 'tab';
      newTab.textContent = '+';
      newTab.onclick = createSheet;
      tabsContainer.appendChild(newTab);
    }

    // 8. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    document.getElementById('new-sheet').addEventListener('click', createSheet);
    document.getElementById('toggle-grid').addEventListener('click', function() {
      state.grid.enabled = !state.grid.enabled;
      this.textContent = `–°–µ—Ç–∫–∞: ${state.grid.enabled ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
      renderCanvas();
    });
    document.getElementById('toggle-snap').addEventListener('click', function() {
      state.grid.snap = !state.grid.snap;
      this.textContent = `–ü—Ä–∏–≤—è–∑–∫–∞: ${state.grid.snap ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
    });
    document.getElementById('grid-step').addEventListener('change', function(e) {
      state.grid.step = Math.max(10, parseInt(e.target.value));
      renderCanvas();
    });
    document.getElementById('tool-line').addEventListener('click', () => setActiveTool('line'));
    document.getElementById('tool-rect').addEventListener('click', () => setActiveTool('rect'));
    document.getElementById('tool-text').addEventListener('click', () => setActiveTool('text'));

    // –ó–∞–ø—É—Å–∫
    loadFromLocalStorage();
    setActiveTool('line');
  </script>
</body>
</html>
