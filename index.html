<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DgrmJS</title>
    <style>
        body { margin:0; overflow:hidden; font-family:Arial; }
        #app { display:flex; flex-direction:column; height:100vh; }
        #toolbar { background:#f0f0f0; padding:8px; gap:8px; display:flex; }
        #canvas-container { flex:1; position:relative; overflow:auto; background:#f9f9f9; }
        #svg-container { position:absolute; width:100%; height:100%; }
        .shape { cursor:move; }
        rect, circle { stroke:#333; stroke-width:2; fill:white; }
        .resize-handle { fill:#1a73e8; cursor:nwse-resize; opacity:0; transition:opacity 0.2s; }
        .shape:hover .resize-handle { opacity:1; }
    </style>
</head>
<body>
    <div id="app">
        <div id="toolbar"></div>
        <div id="canvas-container">
            <svg id="svg-container" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
    </div>

    <script>
        // ============= CORE =============
        class Vector {
            constructor(x = 0, y = 0) {
                this.x = x;
                this.y = y;
            }
            add(v) { return new Vector(this.x + v.x, this.y + v.y); }
            subtract(v) { return new Vector(this.x - v.x, this.y - v.y); }
            multiply(s) { return new Vector(this.x * s, this.y * s); }
            clone() { return new Vector(this.x, this.y); }
            static fromEvent(e, svg) {
                const pt = svg.createSVGPoint();
                pt.x = e.clientX; pt.y = e.clientY;
                return new Vector(pt.x, pt.y);
            }
        }

        class Shape {
            constructor(type, position, size, text = "") {
                this.id = 'shape_' + Math.random().toString(36).substr(2, 9);
                this.type = type;
                this.position = position.clone();
                this.size = size.clone();
                this.text = text;
                this.rotation = 0;
                this.strokeColor = "#333";
                this.fillColor = "#fff";
            }
        }

        // ============= RENDERER =============
        class SVGRenderer {
            constructor(svgElement) {
                this.svg = svgElement;
            }
            
            render(shapes) {
                this.clear();
                shapes.forEach(shape => {
                    const element = this.createShapeElement(shape);
                    this.svg.appendChild(element);
                });
            }
            
            createShapeElement(shape) {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'shape');
                g.setAttribute('data-id', shape.id);
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', shape.position.x);
                rect.setAttribute('y', shape.position.y);
                rect.setAttribute('width', shape.size.x);
                rect.setAttribute('height', shape.size.y);
                rect.setAttribute('fill', shape.fillColor);
                rect.setAttribute('stroke', shape.strokeColor);
                rect.setAttribute('stroke-width', '2');
                g.appendChild(rect);
                
                if (shape.text) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', shape.position.x + shape.size.x / 2);
                    text.setAttribute('y', shape.position.y + shape.size.y / 2);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('dominant-baseline', 'middle');
                    text.textContent = shape.text;
                    g.appendChild(text);
                }
                return g;
            }
            
            clear() {
                this.svg.innerHTML = '';
            }
        }

        // ============= TOOLS =============
        class Tool {
            constructor(app) { this.app = app; }
            onMouseDown(e) {}
            onMouseMove(e) {}
            onMouseUp(e) {}
        }

        class SelectTool extends Tool {
            onMouseDown(e) {
                console.log("Select tool active");
            }
        }

        class RectangleTool extends Tool {
            onMouseDown(e) {
                const pos = Vector.fromEvent(e, this.app.svg);
                const newShape = new Shape(
                    'rectangle',
                    pos,
                    new Vector(150, 100),
                    "Rectangle"
                );
                this.app.addShape(newShape);
            }
        }

        // ============= MAIN APP =============
        class Diagram {
            constructor() {
                this.svg = document.getElementById('svg-container');
                this.shapes = [];
                this.renderer = new SVGRenderer(this.svg);
                this.tools = {
                    select: new SelectTool(this),
                    rectangle: new RectangleTool(this)
                };
                this.currentTool = this.tools.select;
                this.initEvents();
            }
            
            addShape(shape) {
                this.shapes.push(shape);
                this.renderer.render(this.shapes);
            }
            
            initEvents() {
                this.svg.addEventListener('mousedown', (e) => {
                    this.currentTool.onMouseDown(e);
                });
                
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.setTool(btn.dataset.tool);
                    });
                });
            }
            
            setTool(toolName) {
                this.currentTool = this.tools[toolName];
                console.log(`Tool set to: ${toolName}`);
            }
        }

        // ============= INIT =============
        document.addEventListener('DOMContentLoaded', () => {
            const diagram = new Diagram();
            window.diagram = diagram;
            
            // Инициализация UI
            const toolbar = document.getElementById('toolbar');
            ['select', 'rectangle'].forEach(tool => {
                const btn = document.createElement('button');
                btn.className = 'tool-btn';
                btn.textContent = tool.charAt(0).toUpperCase() + tool.slice(1);
                btn.dataset.tool = tool;
                toolbar.appendChild(btn);
            });
            
            console.log("DgrmJS initialized");
        });
    </script>
</body>
</html>
