<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Топографический редактор</title>
    <style>
        /* Стили остаются без изменений из предыдущего ответа */
        body { margin: 0; font-family: Arial, sans-serif; }
        .toolbar { padding: 10px; background: #f0f0f0; }
        canvas { border: 1px solid #ccc; margin: 20px; }
        /* ... остальные стили ... */
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="lineBtn">Линия</button>
        <button id="rectBtn">Прямоугольник</button>
        <button id="circleBtn">Круг</button>
    </div>
    <canvas id="canvas"></canvas>

    <script>
    "use strict";
    
    class Editor {
        constructor() {
            // Отложенная инициализация после проверки элементов
            if (!document.getElementById('canvas')) {
                throw new Error('Canvas element not found');
            }
            
            this.canvas = document.getElementById('canvas');
            this.ctx = this.canvas.getContext('2d');
            
            // Инициализация состояния
            this.state = {
                elements: [],
                selected: new Set(),
                scale: 1,
                offset: { x: 0, y: 0 }
            };
            
            // Настройка размеров canvas
            this.resizeCanvas();
            
            // Инициализация событий
            this.initEventListeners();
        }

        resizeCanvas() {
            this.canvas.width = window.innerWidth - 40;
            this.canvas.height = window.innerHeight - 100;
        }

        initEventListeners() {
            window.addEventListener('resize', () => this.resizeCanvas());
            
            // Инициализация кнопок только после создания экземпляра
            document.getElementById('lineBtn').addEventListener('click', () => this.addLine());
            document.getElementById('rectBtn').addEventListener('click', () => this.addRect());
            document.getElementById('circleBtn').addEventListener('click', () => this.addCircle());
        }

        addLine() {
            this.state.elements.push({
                type: 'line',
                x1: 100, y1: 100,
                x2: 200, y2: 200,
                color: '#ff0000'
            });
            this.draw();
        }

        addRect() {
            this.state.elements.push({
                type: 'rect',
                x: 150, y: 150,
                width: 100, height: 80,
                color: '#00ff00'
            });
            this.draw();
        }

        addCircle() {
            this.state.elements.push({
                type: 'circle',
                x: 300, y: 200,
                radius: 50,
                color: '#0000ff'
            });
            this.draw();
        }

        draw() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            
            // Отрисовка элементов
            this.state.elements.forEach(element => {
                this.ctx.beginPath();
                this.ctx.strokeStyle = element.color;
                
                switch(element.type) {
                    case 'line':
                        this.ctx.moveTo(element.x1, element.y1);
                        this.ctx.lineTo(element.x2, element.y2);
                        break;
                    case 'rect':
                        this.ctx.strokeRect(element.x, element.y, element.width, element.height);
                        break;
                    case 'circle':
                        this.ctx.arc(element.x, element.y, element.radius, 0, Math.PI * 2);
                        break;
                }
                
                this.ctx.stroke();
            });
        }
    }

    // Инициализация после полной загрузки страницы
    window.addEventListener('DOMContentLoaded', () => {
        window.editor = new Editor();
        editor.draw();
    });
    </script>
</body>
</html>
