<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Топографический редактор PRO</title>
  <style>
    /* Все стили остаются без изменений */
    body { margin: 0; font-family: Arial; background: #f5f5f5; overflow: hidden; }
    #app { display: flex; height: 100vh; }
    #toolbar { width: 200px; background: #2c3e50; padding: 15px; color: white; box-shadow: 0 0 10px rgba(0,0,0,0.3); overflow-y: auto; }
    /* ... остальные стили ... */
    .transform-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #1abc9c;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
      z-index: 20;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body>
  <!-- Вся HTML-разметка остается без изменений -->
  <div id="app">
    <!-- ... -->
  </div>

  <script>
    // ========== КОНФИГУРАЦИЯ ==========
    const CONFIG = {
      CANVAS_WIDTH: 2500,
      CANVAS_HEIGHT: 1500,
      GRID_COLOR: '#e0e0e0',
      HANDLE_SIZE: 10,
      SELECTION_COLOR: '#FF0000',
      TEXT_HEIGHT: 16
    };

    // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
    let canvas, ctx, textInput, transformHandles;
    let state = {
      sheets: [],
      currentSheet: 0,
      currentTool: 'select',
      color: '#000000',
      selectedElement: null,
      undoStack: [],
      redoStack: [],
      grid: { enabled: true, snap: true, step: 20, color: CONFIG.GRID_COLOR },
      elements: [],
      renamingSheet: null,
      textInputActive: false,
      isDrawing: false,
      startX: 0,
      startY: 0,
      isDragging: false,
      dragStartX: 0,
      dragStartY: 0,
      transformHandle: null,
      originalElement: null
    };

    // ========== ОСНОВНЫЕ ФУНКЦИИ ==========
    function initElements() {
      canvas = document.getElementById('sheet');
      if (!canvas) throw new Error("Canvas element not found");
      
      ctx = canvas.getContext('2d');
      canvas.width = CONFIG.CANVAS_WIDTH;
      canvas.height = CONFIG.CANVAS_HEIGHT;
      
      textInput = document.getElementById('text-input');
      transformHandles = document.getElementById('transform-handles');
    }

    function initEventListeners() {
      // Проверяем существование элементов перед добавлением обработчиков
      const elements = {
        'new-sheet': () => createSheet(),
        'toggle-grid': function() {
          state.grid.enabled = !state.grid.enabled;
          this.textContent = `Сетка: ${state.grid.enabled ? 'Вкл' : 'Выкл'}`;
          renderCanvas();
        },
        'toggle-snap': function() {
          state.grid.snap = !state.grid.snap;
          this.textContent = `Привязка: ${state.grid.snap ? 'Вкл' : 'Выкл'}`;
        },
        'tool-select': () => setActiveTool('select'),
        'tool-line': () => setActiveTool('line'),
        'tool-rect': () => setActiveTool('rect'),
        'tool-circle': () => setActiveTool('circle'),
        'tool-text': () => setActiveTool('text'),
        'clear-btn': () => {
          if (confirm('Очистить текущий лист?')) {
            saveToUndoStack();
            state.elements = [];
            saveToLocalStorage();
            renderCanvas();
          }
        },
        'export-btn': () => showExportDialog(),
        'rename-confirm': () => confirmRename(),
        'rename-cancel': () => cancelRename(),
        'export-confirm': () => performExport(),
        'export-cancel': () => hideExportDialog()
      };

      for (const [id, handler] of Object.entries(elements)) {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('click', handler);
        } else {
          console.warn(`Element with id ${id} not found`);
        }
      }

      // Обработчики для canvas
      if (canvas) {
        canvas.addEventListener('mousedown', handleCanvasMouseDown);
        canvas.addEventListener('mousemove', handleCanvasMouseMove);
        canvas.addEventListener('mouseup', handleCanvasMouseUp);
      }

      // Обработчики клавиатуры
      document.addEventListener('keydown', handleKeyDown);
      
      // Обработчик для ввода текста
      if (textInput) {
        textInput.addEventListener('keydown', handleTextInputKeyDown);
      }

      // Обработчик изменения цвета
      const colorPicker = document.getElementById('color-picker');
      if (colorPicker) {
        colorPicker.addEventListener('input', (e) => {
          state.color = e.target.value;
          if (state.selectedElement !== null) {
            state.elements[state.selectedElement].color = state.color;
            saveToLocalStorage();
            renderCanvas();
          }
        });
      }

      // Обработчик шага сетки
      const gridStep = document.getElementById('grid-step');
      if (gridStep) {
        gridStep.addEventListener('change', function(e) {
          state.grid.step = Math.max(10, parseInt(e.target.value));
          renderCanvas();
        });
      }
    }

    // ... (остальные функции без изменений: drawGrid, saveToUndoStack, renderElements и т.д.) ...

    // ========== ЗАПУСК ПРИЛОЖЕНИЯ ==========
    function initApp() {
      try {
        initElements();
        initEventListeners();
        loadFromLocalStorage();
        setActiveTool('select');
      } catch (error) {
        console.error("Application initialization failed:", error);
        alert("Произошла ошибка при загрузке приложения. Пожалуйста, обновите страницу.");
      }
    }

    // Запускаем приложение после полной загрузки DOM
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
