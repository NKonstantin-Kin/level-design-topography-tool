<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Level Designer Tool</title>
  <style>
    body { margin: 0; font-family: Arial; overflow: hidden; }
    #app { display: flex; height: 100vh; }
    #toolbar { width: 200px; background: #f5f5f5; border-right: 1px solid #ddd; padding: 10px; overflow-y: auto; }
    #canvas-container { flex: 1; position: relative; overflow: auto; }
    canvas { display: block; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); cursor: crosshair; }
    .tabs { display: flex; background: #eee; padding: 8px 8px 0; flex-wrap: wrap; }
    .tab { padding: 8px 16px; margin: 0 4px 4px 0; background: #ddd; border-radius: 4px 4px 0 0; cursor: pointer; position: relative; }
    .tab.active { background: white; font-weight: bold; }
    .tab-close { position: absolute; right: 2px; top: 2px; font-size: 12px; color: #666; }
    .tool-section { margin-bottom: 15px; }
    button { padding: 8px; margin: 4px 0; width: 100%; }
    button.active-tool { background: #4CAF50; color: white; }
    #text-input { position: absolute; border: 1px dashed #000; padding: 4px; display: none; }
  </style>
</head>
<body>
  <div id="app">
    <div id="toolbar">
      <div class="tool-section">
        <h3>–õ–∏—Å—Ç—ã</h3>
        <button id="new-sheet">+ –ù–æ–≤—ã–π –ª–∏—Å—Ç</button>
      </div>
      <div class="tool-section">
        <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
        <button id="tool-line" class="active-tool">‚úèÔ∏è –õ–∏–Ω–∏—è</button>
        <button id="tool-rect">‚¨õ –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</button>
        <button id="tool-text">üî§ –¢–µ–∫—Å—Ç</button>
      </div>
      <div class="tool-section">
        <h3>–°–µ—Ç–∫–∞</h3>
        <button id="toggle-grid">–°–µ—Ç–∫–∞: –í–∫–ª</button>
        <button id="toggle-snap">–ü—Ä–∏–≤—è–∑–∫–∞: –í–∫–ª</button>
        <label>–®–∞–≥ —Å–µ—Ç–∫–∏: <input type="number" id="grid-step" value="20" min="10"></label>
      </div>
    </div>
    <div id="canvas-container">
      <div class="tabs" id="sheet-tabs"></div>
      <canvas id="sheet"></canvas>
      <div id="text-input" contenteditable="true"></div>
    </div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const canvas = document.getElementById('sheet');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('text-input');
    canvas.width = 3000;
    canvas.height = 2000;

    let state = {
      sheets: [],
      currentSheet: 0,
      currentTool: 'line',
      selectedElement: null,
      grid: {
        enabled: true,
        snap: true,
        step: 20,
        color: '#ddd'
      },
      elements: []
    };

    // 1. –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
    function drawGrid() {
      if (!state.grid.enabled) return;
      ctx.strokeStyle = state.grid.color;
      ctx.lineWidth = 1;
      for (let x = 0; x <= canvas.width; x += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y <= canvas.height; y += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
    }

    // 2. –õ–∏—Å—Ç—ã (—Å —É–¥–∞–ª–µ–Ω–∏–µ–º)
    function createSheet() {
      if (state.sheets.length >= 5) return alert('–ú–∞–∫—Å–∏–º—É–º 5 –ª–∏—Å—Ç–æ–≤!');
      const newSheet = {
        id: Date.now(),
        name: `–õ–∏—Å—Ç ${state.sheets.length + 1}`,
        elements: []
      };
      state.sheets.push(newSheet);
      renderTabs();
      switchSheet(state.sheets.length - 1);
      saveToLocalStorage();
    }

    function deleteSheet(index) {
      if (state.sheets.length <= 1) return alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ª–∏—Å—Ç!');
      state.sheets.splice(index, 1);
      if (state.currentSheet >= index) state.currentSheet = Math.max(0, state.currentSheet - 1);
      renderTabs();
      switchSheet(state.currentSheet);
      saveToLocalStorage();
    }

    function switchSheet(index) {
      state.currentSheet = index;
      state.elements = state.sheets[index].elements;
      state.selectedElement = null;
      renderCanvas();
      renderTabs();
    }

    // 3. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    function setActiveTool(tool) {
      state.currentTool = tool;
      document.querySelectorAll('#toolbar button').forEach(btn => {
        btn.classList.remove('active-tool');
      });
      document.getElementById(`tool-${tool}`).classList.add('active-tool');
      state.selectedElement = null;
      renderCanvas();
    }

    // 4. –†–∏—Å–æ–≤–∞–Ω–∏–µ (–ª–∏–Ω–∏–∏, –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏, —Ç–µ–∫—Å—Ç)
    canvas.addEventListener('mousedown', (e) => {
      if (state.currentTool === 'text') {
        textInput.style.display = 'block';
        textInput.style.left = `${e.offsetX}px`;
        textInput.style.top = `${e.offsetY}px`;
        textInput.focus();
        return;
      }

      const startX = e.offsetX;
      const startY = e.offsetY;
      
      function onMouseMove(e) {
        renderCanvas();
        ctx.beginPath();
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 2;
        
        if (state.currentTool === 'line') {
          ctx.moveTo(startX, startY);
          ctx.lineTo(e.offsetX, e.offsetY);
        } else if (state.currentTool === 'rect') {
          ctx.rect(startX, startY, e.offsetX - startX, e.offsetY - startY);
        }
        
        ctx.stroke();
      }

      function onMouseUp(e) {
        canvas.removeEventListener('mousemove', onMouseMove);
        canvas.removeEventListener('mouseup', onMouseUp);
        
        state.elements.push({
          type: state.currentTool,
          x1: startX,
          y1: startY,
          x2: e.offsetX,
          y2: e.offsetY,
          color: '#000000'
        });
        saveToLocalStorage();
      }

      canvas.addEventListener('mousemove', onMouseMove);
      canvas.addEventListener('mouseup', onMouseUp);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
    textInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const text = textInput.innerText.trim();
        if (text) {
          state.elements.push({
            type: 'text',
            x: parseInt(textInput.style.left),
            y: parseInt(textInput.style.top),
            content: text,
            color: '#000000'
          });
          saveToLocalStorage();
          renderCanvas();
        }
        textInput.style.display = 'none';
        textInput.innerText = '';
      }
    });

    // 5. –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (Delete)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Delete' && state.selectedElement !== null) {
        state.elements.splice(state.selectedElement, 1);
        state.selectedElement = null;
        saveToLocalStorage();
        renderCanvas();
      }
      // Ctrl+Z
      if (e.ctrlKey && e.key === 'z') {
        if (state.elements.length > 0) {
          state.elements.pop();
          saveToLocalStorage();
          renderCanvas();
        }
      }
      // Ctrl+S
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        alert('–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ!');
      }
    });

    // 6. –í—ã–±–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞
    canvas.addEventListener('click', (e) => {
      if (state.currentTool !== 'select') return;
      
      const x = e.offsetX;
      const y = e.offsetY;
      
      state.elements.forEach((el, index) => {
        if (el.type === 'line') {
          // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–∫–∞ —Ä—è–¥–æ–º —Å –ª–∏–Ω–∏–µ–π
          const distance = distanceToLine(x, y, el.x1, el.y1, el.x2, el.y2);
          if (distance < 10) state.selectedElement = index;
        } else if (el.type === 'rect') {
          if (x >= Math.min(el.x1, el.x2) && x <= Math.max(el.x1, el.x2) &&
              y >= Math.min(el.y1, el.y2) && y <= Math.max(el.y1, el.y2)) {
            state.selectedElement = index;
          }
        }
      });
      renderCanvas();
    });

    function distanceToLine(x, y, x1, y1, x2, y2) {
      const A = x - x1;
      const B = y - y1;
      const C = x2 - x1;
      const D = y2 - y1;
      const dot = A * C + B * D;
      const len_sq = C * C + D * D;
      let param = -1;
      if (len_sq !== 0) param = dot / len_sq;
      let xx, yy;
      if (param < 0) {
        xx = x1;
        yy = y1;
      } else if (param > 1) {
        xx = x2;
        yy = y2;
      } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
      }
      return Math.sqrt((x - xx) ** 2 + (y - yy) ** 2);
    }

    // 7. –†–µ–Ω–¥–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º)
    function renderElements() {
      state.elements.forEach((el, index) => {
        ctx.beginPath();
        ctx.strokeStyle = el.color;
        ctx.lineWidth = 2;
        
        if (el.type === 'line') {
          ctx.moveTo(el.x1, el.y1);
          ctx.lineTo(el.x2, el.y2);
          if (index === state.selectedElement) {
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 3;
          }
        } else if (el.type === 'rect') {
          ctx.rect(el.x1, el.y1, el.x2 - el.x1, el.y2 - el.y1);
          if (index === state.selectedElement) {
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 3;
          }
        } else if (el.type === 'text') {
          ctx.fillStyle = el.color;
          ctx.font = '16px Arial';
          ctx.fillText(el.content, el.x, el.y);
          if (index === state.selectedElement) {
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 1;
            ctx.strokeText(el.content, el.x, el.y);
          }
        }
        
        ctx.stroke();
      });
    }

    // 8. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    function saveToLocalStorage() {
      state.sheets[state.currentSheet].elements = state.elements;
      localStorage.setItem('levelDesigner', JSON.stringify(state));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('levelDesigner');
      if (saved) state = JSON.parse(saved);
      if (state.sheets.length === 0) createSheet();
      state.elements = state.sheets[state.currentSheet].elements;
      renderTabs();
      renderCanvas();
    }

    // 9. –û–±—â–∏–π —Ä–µ–Ω–¥–µ—Ä
    function renderCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
      renderElements();
    }

    function renderTabs() {
      const tabsContainer = document.getElementById('sheet-tabs');
      tabsContainer.innerHTML = '';
      state.sheets.forEach((sheet, index) => {
        const tab = document.createElement('div');
        tab.className = `tab ${index === state.currentSheet ? 'active' : ''}`;
        tab.innerHTML = `
          ${sheet.name}
          <span class="tab-close" data-index="${index}">√ó</span>
        `;
        tab.onclick = () => switchSheet(index);
        tabsContainer.appendChild(tab);
      });
      const newTab = document.createElement('div');
      newTab.className = 'tab';
      newTab.textContent = '+';
      newTab.onclick = createSheet;
      tabsContainer.appendChild(newTab);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –ª–∏—Å—Ç–æ–≤
      document.querySelectorAll('.tab-close').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          deleteSheet(parseInt(btn.dataset.index));
        };
      });
    }

    // 10. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    document.getElementById('new-sheet').addEventListener('click', createSheet);
    document.getElementById('toggle-grid').addEventListener('click', function() {
      state.grid.enabled = !state.grid.enabled;
      this.textContent = `–°–µ—Ç–∫–∞: ${state.grid.enabled ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
      renderCanvas();
    });
    document.getElementById('toggle-snap').addEventListener('click', function() {
      state.grid.snap = !state.grid.snap;
      this.textContent = `–ü—Ä–∏–≤—è–∑–∫–∞: ${state.grid.snap ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
    });
    document.getElementById('grid-step').addEventListener('change', function(e) {
      state.grid.step = Math.max(10, parseInt(e.target.value));
      renderCanvas();
    });
    document.getElementById('tool-line').addEventListener('click', () => setActiveTool('line'));
    document.getElementById('tool-rect').addEventListener('click', () => setActiveTool('rect'));
    document.getElementById('tool-text').addEventListener('click', () => setActiveTool('text'));

    // –ó–∞–ø—É—Å–∫
    loadFromLocalStorage();
    setActiveTool('line');
  </script>
</body>
</html>
