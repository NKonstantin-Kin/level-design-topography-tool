<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Топографический редактор PRO</title>
  <style>
    body { 
      margin: 0;
      font-family: Arial;
      background: #f5f5f5;
      overflow: hidden;
    }
    #app { 
      display: flex;
      height: 100vh;
    }
    #toolbar {
      width: 200px;
      background: #2c3e50;
      padding: 15px;
      color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      overflow-y: auto;
    }
    .tool-section {
      margin-bottom: 20px;
      border-bottom: 1px solid #34495e;
      padding-bottom: 15px;
    }
    .tool-section h3 {
      color: #1abc9c;
      margin-top: 0;
      text-align: center;
    }
    .tool-btn {
      display: block;
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      background: #34495e;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      text-align: left;
    }
    .tool-btn:hover {
      background: #3d5166;
      transform: translateY(-2px);
    }
    .tool-btn.active {
      background: #1abc9c;
      font-weight: bold;
    }
    #canvas-container {
      flex: 1;
      position: relative;
      overflow: auto;
      background: #ecf0f1;
    }
    canvas {
      display: block;
      background: white;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      margin: 20px auto;
    }
    .tabs {
      display: flex;
      background: #34495e;
      padding: 8px 8px 0;
      flex-wrap: wrap;
    }
    .tab {
      padding: 8px 16px;
      margin: 0 4px 4px 0;
      background: #2c3e50;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      position: relative;
      color: white;
      transition: all 0.2s;
    }
    .tab:hover {
      background: #3d5166;
    }
    .tab.active {
      background: #1abc9c;
      font-weight: bold;
    }
    .tab-close {
      position: absolute;
      right: 5px;
      top: 5px;
      font-size: 12px;
      color: #e74c3c;
      background: white;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .tab-edit {
      position: absolute;
      right: 25px;
      top: 5px;
      font-size: 12px;
      color: #3498db;
    }
    #text-input {
      position: absolute;
      border: 1px dashed #000;
      padding: 4px;
      display: none;
      background: white;
      z-index: 10;
      min-width: 100px;
      font-family: Arial;
      font-size: 16px;
    }
    #rename-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
    }
    #export-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
    }
    #rename-dialog h3, #export-dialog h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    #rename-dialog input, #export-dialog input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .dialog-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    #rename-dialog button, #export-dialog button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #rename-confirm, #export-confirm {
      background: #1abc9c;
      color: white;
    }
    #rename-cancel, #export-cancel {
      background: #e74c3c;
      color: white;
    }
    .grid-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .grid-controls label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    .grid-controls input {
      width: 60px;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    #color-picker {
      width: 100%;
      height: 40px;
      margin: 10px 0;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    .transform-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #1abc9c;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
      z-index: 20;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="toolbar">
      <!-- ... (тулбар без изменений) ... -->
    </div>
    <div id="canvas-container">
      <div class="tabs" id="sheet-tabs"></div>
      <canvas id="sheet"></canvas>
      <div id="text-input" contenteditable="true"></div>
      <div id="transform-handles"></div>
    </div>
  </div>

  <div id="rename-dialog">
    <h3>Переименовать лист</h3>
    <input type="text" id="rename-input">
    <div class="dialog-buttons">
      <button id="rename-confirm">OK</button>
      <button id="rename-cancel">Отмена</button>
    </div>
  </div>

  <div id="export-dialog">
    <h3>Экспорт в PNG</h3>
    <p>Вы действительно хотите экспортировать текущий лист?</p>
    <div class="dialog-buttons">
      <button id="export-confirm">Экспорт</button>
      <button id="export-cancel">Отмена</button>
    </div>
  </div>

  <script>
    // ========== КОНФИГУРАЦИЯ ==========
    const CONFIG = {
      CANVAS_WIDTH: 2500,
      CANVAS_HEIGHT: 1500,
      GRID_COLOR: '#e0e0e0',
      HANDLE_SIZE: 10,
      SELECTION_COLOR: '#FF0000',
      TEXT_HEIGHT: 20 // Высота текста для правильного позиционирования
    };

    // ========== ИНИЦИАЛИЗАЦИЯ ==========
    const canvas = document.getElementById('sheet');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('text-input');
    const transformHandles = document.getElementById('transform-handles');
    canvas.width = CONFIG.CANVAS_WIDTH;
    canvas.height = CONFIG.CANVAS_HEIGHT;

    let state = {
      // ... (остальное состояние без изменений) ...
    };

    // ========== ОСНОВНЫЕ ФУНКЦИИ ==========
    function renderElements() {
      state.elements.forEach((el, index) => {
        ctx.beginPath();
        ctx.strokeStyle = el.color;
        ctx.fillStyle = el.color;
        ctx.lineWidth = 2;
        
        if (el.type === 'line') {
          ctx.moveTo(el.x1, el.y1);
          ctx.lineTo(el.x2, el.y2);
        } else if (el.type === 'rect') {
          // Рисуем прямоугольник как замкнутую фигуру
          ctx.moveTo(el.x1, el.y1);
          ctx.lineTo(el.x2, el.y1);
          ctx.lineTo(el.x2, el.y2);
          ctx.lineTo(el.x1, el.y2);
          ctx.closePath();
        } else if (el.type === 'circle') {
          const radius = Math.sqrt(
            Math.pow(el.x2 - el.x1, 2) + 
            Math.pow(el.y2 - el.y1, 2)
          );
          ctx.arc(el.x1, el.y1, radius, 0, Math.PI * 2);
        } else if (el.type === 'text') {
          ctx.font = '16px Arial';
          // Корректное позиционирование текста
          ctx.fillText(el.content, el.x, el.y + CONFIG.TEXT_HEIGHT);
        }
        
        if (index === state.selectedElement) {
          ctx.strokeStyle = CONFIG.SELECTION_COLOR;
          ctx.lineWidth = 3;
          if (el.type === 'line') {
            ctx.moveTo(el.x1, el.y1);
            ctx.lineTo(el.x2, el.y2);
          } else if (el.type === 'rect') {
            ctx.moveTo(el.x1, el.y1);
            ctx.lineTo(el.x2, el.y1);
            ctx.lineTo(el.x2, el.y2);
            ctx.lineTo(el.x1, el.y2);
            ctx.closePath();
          } else if (el.type === 'circle') {
            const radius = Math.sqrt(
              Math.pow(el.x2 - el.x1, 2) + 
              Math.pow(el.y2 - el.y1, 2)
            );
            ctx.arc(el.x1, el.y1, radius, 0, Math.PI * 2);
          } else if (el.type === 'text') {
            ctx.strokeText(el.content, el.x, el.y + CONFIG.TEXT_HEIGHT);
          }
        }
        ctx.stroke();
      });
    }

    // ========== ОБРАБОТЧИКИ СОБЫТИЙ ==========
    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (state.currentTool === 'select') {
        // Проверка клика на точку трансформации
        if (state.selectedElement !== null && state.elements[state.selectedElement].type === 'rect') {
          const element = state.elements[state.selectedElement];
          const handles = [
            { x: element.x1, y: element.y1, type: 'nw' },
            { x: (element.x1 + element.x2)/2, y: element.y1, type: 'n' },
            { x: element.x2, y: element.y1, type: 'ne' },
            { x: element.x1, y: (element.y1 + element.y2)/2, type: 'w' },
            { x: element.x2, y: (element.y1 + element.y2)/2, type: 'e' },
            { x: element.x1, y: element.y2, type: 'sw' },
            { x: (element.x1 + element.x2)/2, y: element.y2, type: 's' },
            { x: element.x2, y: element.y2, type: 'se' }
          ];
          
          for (const handle of handles) {
            if (isPointInHandle(x, y, handle.x, handle.y)) {
              state.transformHandle = handle.type;
              state.originalElement = JSON.parse(JSON.stringify(element));
              return;
            }
          }
        }
        
        // ... (остальная логика выделения) ...
      }

      if (state.currentTool === 'text') {
        textInput.style.display = 'block';
        textInput.style.left = `${x}px`;
        // Корректируем позицию для текста
        textInput.style.top = `${y - CONFIG.TEXT_HEIGHT}px`;
        textInput.focus();
        state.textInputActive = true;
        return;
      }
      // ... (остальные инструменты) ...
    });

    // ========== ЭКСПОРТ ==========
    function showExportDialog() {
      document.getElementById('export-dialog').style.display = 'block';
    }

    function hideExportDialog() {
      document.getElementById('export-dialog').style.display = 'none';
    }

    function performExport() {
      // ... (код экспорта без изменений) ...
      hideExportDialog();
    }

    document.getElementById('export-confirm').addEventListener('click', performExport);
    document.getElementById('export-cancel').addEventListener('click', hideExportDialog);
    document.getElementById('export-btn').addEventListener('click', showExportDialog);

    // ========== ЗАПУСК ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadFromLocalStorage();
      setActiveTool('select');
    });
  </script>
</body>
</html>
