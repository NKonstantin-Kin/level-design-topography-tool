<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Level Designer Tool</title>
  <style>
    body { margin: 0; font-family: Arial; overflow: hidden; }
    #app { display: flex; height: 100vh; }
    #toolbar { width: 200px; background: #f5f5f5; border-right: 1px solid #ddd; padding: 10px; overflow-y: auto; }
    #canvas-container { flex: 1; position: relative; overflow: auto; }
    canvas { display: block; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); cursor: crosshair; }
    .tabs { display: flex; background: #eee; padding: 8px 8px 0; flex-wrap: wrap; }
    .tab { padding: 8px 16px; margin: 0 4px 4px 0; background: #ddd; border-radius: 4px 4px 0 0; cursor: pointer; position: relative; }
    .tab.active { background: white; font-weight: bold; }
    .tab-close { position: absolute; right: 2px; top: 2px; font-size: 12px; color: #666; }
    .tab-edit { position: absolute; right: 15px; top: 2px; font-size: 12px; color: #666; }
    .tool-section { margin-bottom: 15px; }
    button { padding: 8px; margin: 4px 0; width: 100%; }
    button.active-tool { background: #4CAF50; color: white; }
    #text-input { 
      position: absolute; 
      border: 1px dashed #000; 
      padding: 4px; 
      display: none;
      background: white;
      transform: translateY(-120%); /* –°–ª–µ–≥–∫–∞ –ø–æ–¥–Ω—è—Ç–æ */
    }
    #rename-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="toolbar">
      <div class="tool-section">
        <h3>–õ–∏—Å—Ç—ã</h3>
        <button id="new-sheet">+ –ù–æ–≤—ã–π –ª–∏—Å—Ç</button>
      </div>
      <div class="tool-section">
        <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
        <button id="tool-select" class="active-tool">üñ±Ô∏è –í—ã–¥–µ–ª–µ–Ω–∏–µ</button>
        <button id="tool-line">‚úèÔ∏è –õ–∏–Ω–∏—è</button>
        <button id="tool-rect">‚¨õ –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</button>
        <button id="tool-text">üî§ –¢–µ–∫—Å—Ç</button>
      </div>
      <div class="tool-section">
        <h3>–°–µ—Ç–∫–∞</h3>
        <button id="toggle-grid">–°–µ—Ç–∫–∞: –í–∫–ª</button>
        <button id="toggle-snap">–ü—Ä–∏–≤—è–∑–∫–∞: –í–∫–ª</button>
        <label>–®–∞–≥ —Å–µ—Ç–∫–∏: <input type="number" id="grid-step" value="20" min="10"></label>
      </div>
    </div>
    <div id="canvas-container">
      <div class="tabs" id="sheet-tabs"></div>
      <canvas id="sheet"></canvas>
      <div id="text-input" contenteditable="true"></div>
    </div>
  </div>

  <div id="rename-dialog">
    <h3>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ª–∏—Å—Ç</h3>
    <input type="text" id="rename-input" style="width: 100%; margin-bottom: 10px;">
    <button id="rename-confirm">OK</button>
    <button id="rename-cancel">–û—Ç–º–µ–Ω–∞</button>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const canvas = document.getElementById('sheet');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('text-input');
    canvas.width = 3000;
    canvas.height = 2000;

    let state = {
      sheets: [],
      currentSheet: 0,
      currentTool: 'select',
      selectedElement: null,
      undoStack: [],
      redoStack: [],
      grid: {
        enabled: true,
        snap: true,
        step: 20,
        color: '#ddd'
      },
      elements: [],
      renamingSheet: null
    };

    // 1. –†–∏—Å–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∫–∏
    function drawGrid() {
      if (!state.grid.enabled) return;
      ctx.strokeStyle = state.grid.color;
      ctx.lineWidth = 1;
      for (let x = 0; x <= canvas.width; x += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y <= canvas.height; y += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
    }

    // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π
    function saveToUndoStack() {
      state.undoStack.push(JSON.stringify({
        elements: [...state.elements],
        sheets: [...state.sheets],
        currentSheet: state.currentSheet
      }));
      state.redoStack = [];
    }

    function undo() {
      if (state.undoStack.length === 0) return;
      state.redoStack.push(JSON.stringify({
        elements: [...state.elements],
        sheets: [...state.sheets],
        currentSheet: state.currentSheet
      }));
      const prevState = JSON.parse(state.undoStack.pop());
      state.elements = prevState.elements;
      state.sheets = prevState.sheets;
      state.currentSheet = prevState.currentSheet;
      saveToLocalStorage();
      renderCanvas();
      renderTabs();
    }

    // 3. –†–∞–±–æ—Ç–∞ —Å –ª–∏—Å—Ç–∞–º–∏
    function createSheet() {
      if (state.sheets.length >= 5) return alert('–ú–∞–∫—Å–∏–º—É–º 5 –ª–∏—Å—Ç–æ–≤!');
      saveToUndoStack();
      
      const newSheet = {
        id: Date.now(),
        name: `–õ–∏—Å—Ç ${state.sheets.length + 1}`,
        elements: []
      };
      state.sheets.push(newSheet);
      renderTabs();
      switchSheet(state.sheets.length - 1);
      saveToLocalStorage();
    }

    function deleteSheet(index) {
      if (state.sheets.length <= 1) return alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ª–∏—Å—Ç!');
      saveToUndoStack();
      
      state.sheets.splice(index, 1);
      if (state.currentSheet >= index) state.currentSheet = Math.max(0, state.currentSheet - 1);
      renderTabs();
      switchSheet(state.currentSheet);
      saveToLocalStorage();
    }

    function renameSheet(index) {
      state.renamingSheet = index;
      document.getElementById('rename-input').value = state.sheets[index].name;
      document.getElementById('rename-dialog').style.display = 'block';
    }

    function confirmRename() {
      const newName = document.getElementById('rename-input').value.trim();
      if (newName && state.renamingSheet !== null) {
        saveToUndoStack();
        state.sheets[state.renamingSheet].name = newName;
        saveToLocalStorage();
        renderTabs();
      }
      cancelRename();
    }

    function cancelRename() {
      document.getElementById('rename-dialog').style.display = 'none';
      state.renamingSheet = null;
    }

    function switchSheet(index) {
      state.currentSheet = index;
      state.elements = state.sheets[index].elements;
      state.selectedElement = null;
      renderCanvas();
      renderTabs();
    }

    // 4. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    function setActiveTool(tool) {
      state.currentTool = tool;
      document.querySelectorAll('#toolbar button').forEach(btn => {
        btn.classList.remove('active-tool');
      });
      document.getElementById(`tool-${tool}`).classList.add('active-tool');
      state.selectedElement = null;
      renderCanvas();
    }

    // 5. –†–∏—Å–æ–≤–∞–Ω–∏–µ
    canvas.addEventListener('mousedown', (e) => {
      if (state.currentTool === 'select') {
        const x = e.offsetX;
        const y = e.offsetY;
        state.selectedElement = null;
        
        state.elements.forEach((el, index) => {
          if (el.type === 'line') {
            if (distanceToLine(x, y, el.x1, el.y1, el.x2, el.y2) < 10) {
              state.selectedElement = index;
            }
          } else if (el.type === 'rect') {
            if (x >= Math.min(el.x1, el.x2) && x <= Math.max(el.x1, el.x2) &&
                y >= Math.min(el.y1, el.y2) && y <= Math.max(el.y1, el.y2)) {
              state.selectedElement = index;
            }
          } else if (el.type === 'text') {
            if (x >= el.x - 5 && x <= el.x + ctx.measureText(el.content).width + 5 &&
                y >= el.y - 16 && y <= el.y + 5) {
              state.selectedElement = index;
            }
          }
        });
        renderCanvas();
        return;
      }

      if (state.currentTool === 'text') {
        textInput.style.display = 'block';
        textInput.style.left = `${e.offsetX}px`;
        textInput.style.top = `${e.offsetY + 20}px`; // –°–º–µ—â–µ–Ω–∏–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        textInput.focus();
        return;
      }

      saveToUndoStack();
      const startX = e.offsetX;
      const startY = e.offsetY;
      
      function onMouseMove(e) {
        renderCanvas();
        ctx.beginPath();
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 2;
        
        if (state.currentTool === 'line') {
          ctx.moveTo(startX, startY);
          ctx.lineTo(e.offsetX, e.offsetY);
        } else if (state.currentTool === 'rect') {
          ctx.rect(startX, startY, e.offsetX - startX, e.offsetY - startY);
        }
        ctx.stroke();
      }

      function onMouseUp(e) {
        canvas.removeEventListener('mousemove', onMouseMove);
        canvas.removeEventListener('mouseup', onMouseUp);
        
        state.elements.push({
          type: state.currentTool,
          x1: startX,
          y1: startY,
          x2: e.offsetX,
          y2: e.offsetY,
          color: '#000000'
        });
        saveToLocalStorage();
        renderCanvas();
      }

      canvas.addEventListener('mousemove', onMouseMove);
      canvas.addEventListener('mouseup', onMouseUp);
    });

    // 6. –¢–µ–∫—Å—Ç
    textInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const text = textInput.innerText.trim();
        if (text) {
          saveToUndoStack();
          state.elements.push({
            type: 'text',
            x: parseInt(textInput.style.left),
            y: parseInt(textInput.style.top) + 20, // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏
            content: text,
            color: '#000000'
          });
          saveToLocalStorage();
          renderCanvas();
        }
        textInput.style.display = 'none';
        textInput.innerText = '';
      }
    });

    // 7. –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    document.addEventListener('keydown', (e) => {
      // Delete
      if (e.key === 'Delete' && state.selectedElement !== null) {
        saveToUndoStack();
        state.elements.splice(state.selectedElement, 1);
        state.selectedElement = null;
        saveToLocalStorage();
        renderCanvas();
      }
      
      // Ctrl+Z
      if (e.ctrlKey && e.key === 'z') {
        e.preventDefault();
        undo();
      }
      
      // Ctrl+S
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        exportToPNG();
      }
    });

    // 8. –≠–∫—Å–ø–æ—Ä—Ç –≤ PNG
    function exportToPNG() {
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      
      // –†–∏—Å—É–µ–º —Ñ–æ–Ω
      tempCtx.fillStyle = 'white';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
      
      // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
      if (state.grid.enabled) {
        tempCtx.strokeStyle = state.grid.color;
        tempCtx.lineWidth = 1;
        for (let x = 0; x <= tempCanvas.width; x += state.grid.step) {
          tempCtx.beginPath();
          tempCtx.moveTo(x, 0);
          tempCtx.lineTo(x, tempCanvas.height);
          tempCtx.stroke();
        }
        for (let y = 0; y <= tempCanvas.height; y += state.grid.step) {
          tempCtx.beginPath();
          tempCtx.moveTo(0, y);
          tempCtx.lineTo(tempCanvas.width, y);
          tempCtx.stroke();
        }
      }
      
      // –†–∏—Å—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
      state.elements.forEach(el => {
        tempCtx.beginPath();
        tempCtx.strokeStyle = el.color;
        tempCtx.fillStyle = el.color;
        tempCtx.lineWidth = 2;
        
        if (el.type === 'line') {
          tempCtx.moveTo(el.x1, el.y1);
          tempCtx.lineTo(el.x2, el.y2);
        } else if (el.type === 'rect') {
          tempCtx.rect(el.x1, el.y1, el.x2 - el.x1, el.y2 - el.y1);
        } else if (el.type === 'text') {
          tempCtx.font = '16px Arial';
          tempCtx.fillText(el.content, el.x, el.y);
        }
        tempCtx.stroke();
      });
      
      const link = document.createElement('a');
      link.download = `${state.sheets[state.currentSheet].name}.png`;
      link.href = tempCanvas.toDataURL('image/png');
      link.click();
    }

    // 9. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function distanceToLine(x, y, x1, y1, x2, y2) {
      const A = x - x1;
      const B = y - y1;
      const C = x2 - x1;
      const D = y2 - y1;
      const dot = A * C + B * D;
      const len_sq = C * C + D * D;
      let param = -1;
      if (len_sq !== 0) param = dot / len_sq;
      let xx, yy;
      if (param < 0) {
        xx = x1;
        yy = y1;
      } else if (param > 1) {
        xx = x2;
        yy = y2;
      } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
      }
      return Math.sqrt((x - xx) ** 2 + (y - yy) ** 2);
    }

    // 10. –†–µ–Ω–¥–µ—Ä
    function renderElements() {
      state.elements.forEach((el, index) => {
        ctx.beginPath();
        ctx.strokeStyle = el.color;
        ctx.fillStyle = el.color;
        ctx.lineWidth = 2;
        
        if (el.type === 'line') {
          ctx.moveTo(el.x1, el.y1);
          ctx.lineTo(el.x2, el.y2);
        } else if (el.type === 'rect') {
          ctx.rect(el.x1, el.y1, el.x2 - el.x1, el.y2 - el.y1);
        } else if (el.type === 'text') {
          ctx.font = '16px Arial';
          ctx.fillText(el.content, el.x, el.y);
        }
        
        if (index === state.selectedElement) {
          ctx.strokeStyle = '#FF0000';
          ctx.lineWidth = 3;
          if (el.type === 'line') {
            ctx.moveTo(el.x1, el.y1);
            ctx.lineTo(el.x2, el.y2);
          } else if (el.type === 'rect') {
            ctx.rect(el.x1, el.y1, el.x2 - el.x1, el.y2 - el.y1);
          } else if (el.type === 'text') {
            ctx.strokeText(el.content, el.x, el.y);
          }
        }
        ctx.stroke();
      });
    }

    function renderCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
      renderElements();
    }

    function renderTabs() {
      const tabsContainer = document.getElementById('sheet-tabs');
      tabsContainer.innerHTML = '';
      state.sheets.forEach((sheet, index) => {
        const tab = document.createElement('div');
        tab.className = `tab ${index === state.currentSheet ? 'active' : ''}`;
        tab.innerHTML = `
          ${sheet.name}
          <span class="tab-edit" data-index="${index}">‚úèÔ∏è</span>
          <span class="tab-close" data-index="${index}">√ó</span>
        `;
        tab.onclick = () => switchSheet(index);
        tabsContainer.appendChild(tab);
      });
      
      const newTab = document.createElement('div');
      newTab.className = 'tab';
      newTab.textContent = '+';
      newTab.onclick = createSheet;
      tabsContainer.appendChild(newTab);

      document.querySelectorAll('.tab-close').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          deleteSheet(parseInt(btn.dataset.index));
        };
      });

      document.querySelectorAll('.tab-edit').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          renameSheet(parseInt(btn.dataset.index));
        };
      });
    }

    // 11. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞
    function saveToLocalStorage() {
      state.sheets[state.currentSheet].elements = state.elements;
      localStorage.setItem('levelDesigner', JSON.stringify(state));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('levelDesigner');
      if (saved) {
        state = JSON.parse(saved);
        // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
        if (performance.navigation.type === 1) {
          localStorage.removeItem('levelDesigner');
          state.sheets = [];
          state.elements = [];
          createSheet();
          return;
        }
      }
      if (state.sheets.length === 0) createSheet();
      state.elements = state.sheets[state.currentSheet].elements;
      state.undoStack = [];
      state.redoStack = [];
      renderTabs();
      renderCanvas();
    }

    // 12. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    document.getElementById('new-sheet').addEventListener('click', createSheet);
    document.getElementById('toggle-grid').addEventListener('click', function() {
      state.grid.enabled = !state.grid.enabled;
      this.textContent = `–°–µ—Ç–∫–∞: ${state.grid.enabled ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
      renderCanvas();
    });
    document.getElementById('toggle-snap').addEventListener('click', function() {
      state.grid.snap = !state.grid.snap;
      this.textContent = `–ü—Ä–∏–≤—è–∑–∫–∞: ${state.grid.snap ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
    });
    document.getElementById('grid-step').addEventListener('change', function(e) {
      state.grid.step = Math.max(10, parseInt(e.target.value));
      renderCanvas();
    });
    document.getElementById('tool-select').addEventListener('click', () => setActiveTool('select'));
    document.getElementById('tool-line').addEventListener('click', () => setActiveTool('line'));
    document.getElementById('tool-rect').addEventListener('click', () => setActiveTool('rect'));
    document.getElementById('tool-text').addEventListener('click', () => setActiveTool('text'));
    document.getElementById('rename-confirm').addEventListener('click', confirmRename);
    document.getElementById('rename-cancel').addEventListener('click', cancelRename);

    // 13. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
    function clearCache() {
      localStorage.removeItem('levelDesigner');
      location.reload(true);
    }

    // –ó–∞–ø—É—Å–∫
    loadFromLocalStorage();
    setActiveTool('select');

    // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –¥–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
    const clearBtn = document.createElement('button');
    clearBtn.textContent = '–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)';
    clearBtn.style.position = 'fixed';
    clearBtn.style.bottom = '10px';
    clearBtn.style.right = '10px';
    clearBtn.style.zIndex = '1000';
    clearBtn.onclick = clearCache;
    document.body.appendChild(clearBtn);
  </script>
</body>
</html>
