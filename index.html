<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>–¢–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä PRO</title>
  <style>
    body { margin: 0; font-family: Arial; background: #f5f5f5; overflow: hidden; }
    #app { display: flex; height: 100vh; }
    #toolbar { width: 200px; background: #2c3e50; padding: 15px; color: white; box-shadow: 0 0 10px rgba(0,0,0,0.3); overflow-y: auto; }
    .tool-section { margin-bottom: 20px; border-bottom: 1px solid #34495e; padding-bottom: 15px; }
    .tool-section h3 { color: #1abc9c; margin-top: 0; text-align: center; }
    .tool-btn { display: block; margin: 10px 0; padding: 10px; width: 100%; background: #34495e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; text-align: left; }
    .tool-btn:hover { background: #3d5166; transform: translateY(-2px); }
    .tool-btn.active { background: #1abc9c; font-weight: bold; }
    #canvas-container { flex: 1; position: relative; overflow: auto; background: #ecf0f1; }
    canvas { display: block; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.1); margin: 20px auto; }
    .tabs { display: flex; background: #34495e; padding: 8px 8px 0; flex-wrap: wrap; }
    .tab { padding: 8px 16px; margin: 0 4px 4px 0; background: #2c3e50; border-radius: 4px 4px 0 0; cursor: pointer; position: relative; color: white; transition: all 0.2s; }
    .tab:hover { background: #3d5166; }
    .tab.active { background: #1abc9c; font-weight: bold; }
    .tab-close { position: absolute; right: 5px; top: 5px; font-size: 12px; color: #e74c3c; background: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; line-height: 1; }
    .tab-edit { position: absolute; right: 25px; top: 5px; font-size: 12px; color: #3498db; }
    #text-input { position: absolute; border: 1px dashed #000; padding: 4px; display: none; background: white; z-index: 10; min-width: 100px; font-family: Arial; font-size: 16px; }
    #rename-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; border: 1px solid #ccc; box-shadow: 0 0 20px rgba(0,0,0,0.2); z-index: 100; display: none; }
    #rename-dialog h3 { margin-top: 0; color: #2c3e50; }
    #rename-dialog input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
    #rename-dialog button { padding: 8px 15px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; }
    #rename-confirm { background: #1abc9c; color: white; }
    #rename-cancel { background: #e74c3c; color: white; }
    .grid-controls { display: flex; flex-direction: column; gap: 10px; }
    .grid-controls label { display: flex; justify-content: space-between; align-items: center; color: white; }
    .grid-controls input { width: 60px; padding: 5px; border-radius: 4px; border: 1px solid #ddd; }
    #color-picker { width: 100%; height: 40px; margin: 10px 0; cursor: pointer; border: none; border-radius: 4px; }
    .resize-handle { position: absolute; width: 8px; height: 8px; background: #1a73e8; border-radius: 50%; transform: translate(-50%, -50%); cursor: nwse-resize; z-index: 10; }
    canvas.move-cursor { cursor: grab; }
    canvas.move-cursor:active { cursor: grabbing; }
    .selection-box { position: absolute; border: 2px dashed #1a73e8; background: rgba(26, 115, 232, 0.1); pointer-events: none; display: none; }
  </style>
</head>
<body>
  <div id="app">
    <div id="toolbar">
      <div class="tool-section">
        <h3>–õ–∏—Å—Ç—ã</h3>
        <button id="new-sheet" class="tool-btn">+ –ù–æ–≤—ã–π –ª–∏—Å—Ç</button>
      </div>
      <div class="tool-section">
        <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
        <button id="tool-select" class="tool-btn active">üñ±Ô∏è –í—ã–¥–µ–ª–µ–Ω–∏–µ</button>
        <button id="tool-line" class="tool-btn">‚úèÔ∏è –õ–∏–Ω–∏—è</button>
        <button id="tool-rect" class="tool-btn">‚¨ú –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</button>
        <button id="tool-circle" class="tool-btn">üîµ –ö—Ä—É–≥</button>
        <button id="tool-text" class="tool-btn">üî§ –¢–µ–∫—Å—Ç</button>
        <button id="tool-copy" class="tool-btn">‚éò –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å (Ctrl+C)</button>
        <button id="tool-paste" class="tool-btn">‚éô –í—Å—Ç–∞–≤–∏—Ç—å (Ctrl+V)</button>
        <!-- –ö–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
      </div>
      <div class="tool-section">
        <h3>–°–≤–æ–π—Å—Ç–≤–∞</h3>
        <input type="color" id="color-picker" value="#000000">
      </div>
      <div class="tool-section">
        <h3>–°–µ—Ç–∫–∞</h3>
        <div class="grid-controls">
          <button id="toggle-grid" class="tool-btn">–°–µ—Ç–∫–∞: –í–∫–ª</button>
          <button id="toggle-snap" class="tool-btn">–ü—Ä–∏–≤—è–∑–∫–∞: –í–∫–ª</button>
          <label>
            –®–∞–≥ —Å–µ—Ç–∫–∏:
            <input type="number" id="grid-step" value="20" min="10">
          </label>
        </div>
      </div>
      <div class="tool-section">
        <button id="clear-btn" class="tool-btn">‚ùå –û—á–∏—Å—Ç–∏—Ç—å –ª–∏—Å—Ç</button>
        <button id="export-btn" class="tool-btn">üíæ –≠–∫—Å–ø–æ—Ä—Ç PNG</button>
      </div>
    </div>
    <div id="canvas-container">
      <div class="tabs" id="sheet-tabs"></div>
      <canvas id="sheet"></canvas>
      <div id="text-input" contenteditable="true"></div>
      <div id="selection-box" class="selection-box"></div>
    </div>
  </div>

  <div id="rename-dialog">
    <h3>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ª–∏—Å—Ç</h3>
    <input type="text" id="rename-input">
    <button id="rename-confirm">OK</button>
    <button id="rename-cancel">–û—Ç–º–µ–Ω–∞</button>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
    const CONFIG = {
      INIT_WIDTH: 2500,
      INIT_HEIGHT: 1500,
      GRID_COLOR: '#e0e0e0',
      MARGIN: 200,
      MIN_CANVAS_SIZE: 500
    };

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –≠–õ–ï–ú–ï–ù–¢–û–í ==========
    const canvas = document.getElementById('sheet');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('text-input');
    const selectionBox = document.getElementById('selection-box');
    const toolsSection = document.querySelector('#toolbar .tool-section:nth-child(2)');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (!canvas || !ctx || !toolsSection) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM');
      return;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
    canvas.width = CONFIG.INIT_WIDTH;
    canvas.height = CONFIG.INIT_HEIGHT;

    // ========== –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
    let state = {
      sheets: [],
      currentSheet: 0,
      currentTool: 'select',
      color: '#000000',
      selectedElement: null,
      clipboard: null,
      undoStack: [],
      redoStack: [],
      grid: { enabled: true, snap: true, step: 20, color: CONFIG.GRID_COLOR },
      elements: [],
      renamingSheet: null,
      textInputActive: false,
      isDrawing: false,
      isResizing: false,
      resizeHandle: null,
      startX: 0,
      startY: 0,
      isMovingCanvas: false,
      canvasOffset: { x: 0, y: 0 },
      lastMousePos: { x: 0, y: 0 },
      isMovingElement: false,
      originalElementPos: null,
      isBoxSelecting: false,
      boxSelectStart: { x: 0, y: 0 }
    };

    // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function drawGrid() {
      if (!state.grid.enabled) return;
      
      ctx.save();
      ctx.translate(state.canvasOffset.x, state.canvasOffset.y);
      
      ctx.strokeStyle = state.grid.color;
      ctx.lineWidth = 1;
      
      // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
      for (let x = 0; x <= canvas.width; x += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      
      // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
      for (let y = 0; y <= canvas.height; y += state.grid.step) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
      
      ctx.restore();
    }

    function renderCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
      renderElements();
    }

    function renderElements() {
      ctx.save();
      ctx.translate(state.canvasOffset.x, state.canvasOffset.y);
      
      state.elements.forEach((el, index) => {
        ctx.beginPath();
        ctx.strokeStyle = el.color;
        ctx.fillStyle = el.color;
        ctx.lineWidth = 2;
        
        if (el.type === 'line') {
          ctx.moveTo(el.x1, el.y1);
          ctx.lineTo(el.x2, el.y2);
          ctx.stroke();
        } else if (el.type === 'rect') {
          ctx.rect(el.x1, el.y1, el.x2 - el.x1, el.y2 - el.y1);
          ctx.stroke();
        } else if (el.type === 'circle') {
          const radius = Math.sqrt(Math.pow(el.x2 - el.x1, 2) + Math.pow(el.y2 - el.y1, 2));
          ctx.arc(el.x1, el.y1, radius, 0, Math.PI * 2);
          ctx.stroke();
        } else if (el.type === 'text') {
          ctx.font = '16px Arial';
          ctx.fillText(el.content, el.x, el.y);
        } else if (el.type === 'group') {
          ctx.strokeStyle = '#1a73e8';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 3]);
          ctx.strokeRect(el.x, el.y, el.width, el.height);
          ctx.setLineDash([]);
        }
        
        if (index === state.selectedElement) {
          ctx.strokeStyle = '#1a73e8';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 3]);
          
          if (el.type === 'line') {
            ctx.moveTo(el.x1, el.y1);
            ctx.lineTo(el.x2, el.y2);
            ctx.stroke();
          } else if (el.type === 'rect' || el.type === 'group') {
            const width = el.type === 'rect' ? el.x2 - el.x1 : el.width;
            const height = el.type === 'rect' ? el.y2 - el.y1 : el.height;
            ctx.strokeRect(el.x1 || el.x, el.y1 || el.y, width, height);
          } else if (el.type === 'circle') {
            const radius = Math.sqrt(Math.pow(el.x2 - el.x1, 2) + Math.pow(el.y2 - el.y1, 2));
            ctx.arc(el.x1, el.y1, radius, 0, Math.PI * 2);
            ctx.stroke();
          } else if (el.type === 'text') {
            ctx.strokeText(el.content, el.x, el.y);
          }
          
          ctx.setLineDash([]);
        }
      });
      
      ctx.restore();
    }

    // ========== –§–£–ù–ö–¶–ò–ò –ì–†–£–ü–ü–ò–†–û–í–ö–ò ==========
    function groupElements() {
      if (state.selectedElement === null) return;
      
      const selected = state.elements[state.selectedElement];
      if (!selected) return;
      
      saveToUndoStack();
      
      const group = {
        id: 'group-' + Date.now(),
        type: 'group',
        children: [selected.id],
        x: selected.x1 || selected.x,
        y: selected.y1 || selected.y,
        width: (selected.x2 ? selected.x2 - selected.x1 : ctx.measureText(selected.content).width),
        height: (selected.y2 ? selected.y2 - selected.y1 : 20),
        color: selected.color
      };
      
      state.elements.splice(state.selectedElement, 1);
      state.elements.push(group);
      state.selectedElement = state.elements.length - 1;
      
      saveToLocalStorage();
      renderCanvas();
    }

    function ungroupElements() {
      if (state.selectedElement === null) return;
      
      const selected = state.elements[state.selectedElement];
      if (!selected || selected.type !== 'group') return;
      
      saveToUndoStack();
      
      const groupChildren = state.elements.filter(el => 
        selected.children.includes(el.id)
      );
      
      state.elements.splice(state.selectedElement, 1);
      state.elements = state.elements.concat(groupChildren);
      state.selectedElement = null;
      
      saveToLocalStorage();
      renderCanvas();
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
    function initToolbar() {
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
      const groupBtn = document.createElement('button');
      groupBtn.id = 'group-btn';
      groupBtn.className = 'tool-btn';
      groupBtn.textContent = '–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å (Ctrl+G)';
      groupBtn.addEventListener('click', groupElements);
      toolsSection.appendChild(groupBtn);

      const ungroupBtn = document.createElement('button');
      ungroupBtn.id = 'ungroup-btn';
      ungroupBtn.className = 'tool-btn';
      ungroupBtn.textContent = '–†–∞–∑–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å (Ctrl+Shift+G)';
      ungroupBtn.addEventListener('click', ungroupElements);
      toolsSection.appendChild(ungroupBtn);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      document.getElementById('new-sheet').addEventListener('click', createSheet);
      document.getElementById('toggle-grid').addEventListener('click', function() {
        state.grid.enabled = !state.grid.enabled;
        this.textContent = `–°–µ—Ç–∫–∞: ${state.grid.enabled ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
        renderCanvas();
      });
      // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)
    }

    // ========== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
    function init() {
      initToolbar();
      loadFromLocalStorage();
      setActiveTool('select');
      renderCanvas();
    }

    init();
  });
  </script>
</body>
</html>
